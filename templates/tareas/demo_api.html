{% extends 'base.html' %}

{% block content %}

<div class="top-actions">
    <a href="{% url 'logout' %}" class="btn btn-danger" title="Cerar sesion"><i class="fa-solid fa-right-from-bracket"></i></a>
</div>

<div class="container">
    <div class="lofi-player">
        <h1><i class="fa-solid fa-music"></i> Música</h1>
        <audio id="lofiAudio" controls autoplay loop>
            <source src="https://streams.ilovemusic.de/iloveradio24.mp3" type="audio/mpeg">
            Tu navegador no soporta la reproducción de audio.
        </audio>
    </div>
    <h1>API Tareas</h1>
    <!-- Crear Tarea -->
    <div class="form-container task-form">
        <form id="create-task-form">
            <input type="text" id="title" placeholder="Título de la tarea" required>
            <textarea id="description" placeholder="Descripción (opcional)"></textarea>
            <input type="date" id="due_date">
            <select id="priority">
                <option value="Baja">Baja</option>
                <option value="Media" selected>Media</option>
                <option value="Alta">Alta</option>
            </select>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Crear tarea</button>
            </div>
        </form>
    </div>

    <hr>

    <h2>Lista de tareas</h2>
    <ul id="task-list" style="list-style: none; padding: 0;"></ul>
</div>

<script>
const token = '{{ token }}';
const apiUrl = '/api/tareas/';

async function getTasks() {
    try {
        const response = await fetch(apiUrl, {
            headers: {'Authorization': 'Bearer ' + token}
        });
        if (!response.ok) throw new Error('Error al obtener tareas');
        const data = await response.json();
        const list = document.getElementById('task-list');
        list.innerHTML = '';

        data.forEach(task => {
            const li = document.createElement('li');

            // Contenedor (título | fecha | prioridad)
            const topDiv = document.createElement('div');
            topDiv.style.display = 'flex';
            topDiv.style.alignItems = 'center';
            topDiv.style.gap = '10px';
            topDiv.style.flexWrap = 'wrap'; // adaptar espacio

            const titleInput = document.createElement('input');
            titleInput.value = task.title;
            titleInput.style.width = '150px';

            const dateInput = document.createElement('input');
            dateInput.type = 'date';
            dateInput.value = task.due_date || '';

            const prioritySelect = document.createElement('select');
            ['Baja', 'Media', 'Alta'].forEach(p => {
                const option = document.createElement('option');
                option.value = p;
                option.textContent = p;
                if (p === task.priority) option.selected = true;
                prioritySelect.appendChild(option);
            });

            // Contenedor (descripción | botones)
            const bottomDiv = document.createElement('div');
            bottomDiv.style.display = 'flex';
            bottomDiv.style.alignItems = 'center';
            bottomDiv.style.gap = '10px';
            bottomDiv.style.marginTop = '8px';

            const descInput = document.createElement('textarea');
            descInput.value = task.description || '';
            descInput.style.width = '250px';
            descInput.style.height = '60px';
            descInput.style.resize = 'vertical';

            // Botones
            const saveBtn = document.createElement('button');
            saveBtn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i>';
            saveBtn.title = 'Guardar tarea';
            saveBtn.className = 'btn btn-secondary';
            saveBtn.onclick = async () => {
                try {
                    const res = await fetch(apiUrl + task.id + '/', {
                        method: 'PATCH',
                        headers: {
                            'Authorization': 'Bearer ' + token,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            title: titleInput.value,
                            description: descInput.value,
                            due_date: dateInput.value,
                            priority: prioritySelect.value
                        })
                    });
                    if (!res.ok) throw new Error('Error al actualizar tarea');
                    getTasks();
                } catch (err) { alert(err.message); }
            };

            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
            deleteBtn.title = 'Eliminar tarea';
            deleteBtn.className = 'btn btn-danger';
            deleteBtn.onclick = async () => {
                if (!confirm('¿Seguro que deseas eliminar esta tarea?')) return;
                try {
                    const res = await fetch(apiUrl + task.id + '/', {
                        method: 'DELETE',
                        headers: {'Authorization': 'Bearer ' + token}
                    });
                    if (res.status !== 204) throw new Error('Error al eliminar tarea');
                    getTasks();
                } catch (err) { alert(err.message); }
            };

            const toggleBtn = document.createElement('button');
            toggleBtn.innerHTML = '<i class="fa-solid fa-arrows-rotate"></i>';
            toggleBtn.title = task.is_completed ? 'Marcar Incompleta' : 'Marcar Completa';
            toggleBtn.className = 'btn btn-tertiary';
            toggleBtn.onclick = async () => {
                try {
                    const res = await fetch(apiUrl + task.id + '/', {
                        method: 'PATCH',
                        headers: {
                            'Authorization': 'Bearer ' + token,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ is_completed: !task.is_completed })
                    });
                    if (!res.ok) throw new Error('Error al actualizar estado');
                    getTasks();
                } catch (err) { alert(err.message); }
            };

            // Estructura
            topDiv.appendChild(titleInput);
            topDiv.appendChild(dateInput);
            topDiv.appendChild(prioritySelect);

            bottomDiv.appendChild(descInput);
            bottomDiv.appendChild(saveBtn);
            bottomDiv.appendChild(deleteBtn);
            bottomDiv.appendChild(toggleBtn);

            li.appendChild(topDiv);
            li.appendChild(bottomDiv);

            // Color del estado
            li.className = task.is_completed ? 'completed' : 'incomplete';

            list.appendChild(li);
        });

    } catch (error) {
        alert(error.message);
    }
}

// Crear tarea
document.getElementById('create-task-form').addEventListener('submit', async e => {
    e.preventDefault();
    const title = document.getElementById('title').value;
    const description = document.getElementById('description').value;
    const due_date = document.getElementById('due_date').value;
    const priority = document.getElementById('priority').value;

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ title, description, due_date, priority })
        });
        if (!response.ok) throw new Error('Error al crear tarea');
        document.getElementById('create-task-form').reset();
        getTasks();
    } catch (error) {
        alert(error.message);
    }
});

// Cargar tareas al inicio
getTasks();

const lofiAudio = document.getElementById('lofiAudio');
lofiAudio.volume = 0.15;
</script>
{% endblock %}
